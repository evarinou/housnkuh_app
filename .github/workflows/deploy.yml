name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        # Entferne die cache-Option, da keine Sperrdateien vorhanden sind
        # cache: 'npm'
        
    - name: Install and build client
      run: |
        cd client
        npm install
        npm run build
        
    - name: Install and build server
      run: |
        cd server
        npm install
        npm run build
        
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
           # PATH explizit setzen (Pfade an deine Server-Konfiguration anpassen!)
           # Beispielpfade - ersetze diese mit den Ergebnissen von 'which npm' etc.
           # Achte darauf, nur das Verzeichnis (ohne den Befehl selbst) hinzuzufügen
           export PATH=$PATH:/root/.nvm/versions/node/v22.15.0/bin/node # Falls npm/node hier ist
           export PATH=$PATH:/root/.nvm/versions/node/v22.15.0/bin/pm2 # Falls npm/node/pm2 hier ist
           # Wenn du NVM verwendest, ist dieser Block weiterhin gut:
           export NVM_DIR="$HOME/.nvm"
           [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # Sourcing der Profile beibehalten, schadet nicht
            if [ -f ~/.profile ]; then
             . ~/.profile
              echo "~/.profile geladen."
            fi
            if [ -f ~/.bashrc ]; then
             . ~/.bashrc
              echo "~/.bashrc geladen."
                fi

           echo "Aktueller Pfad nach explizitem Setzen und Laden der Profile: $PATH"
           echo "npm Version: $(npm --version || echo 'npm immer noch nicht gefunden')"
           echo "node Version: $(node --version || echo 'node immer noch nicht gefunden')"
           echo "pm2 Version: $(pm2 --version || echo 'pm2 immer noch nicht gefunden')"


          # --- Dein restliches Deployment-Skript ---
          echo "Wechsle zu /var/www/housnkuh"
          cd /var/www/housnkuh
          
          echo "Repository wird aktualisiert..."
          git pull
          
          echo "Client-Abhängigkeiten werden installiert und Client wird gebaut..."
          cd client
          npm install --production --legacy-peer-deps
          npm run build
          
          echo "Server-Abhängigkeiten werden installiert und Server wird gebaut..."
          cd ../server
          npm install --production --legacy-peer-deps
          npm run build
          
          echo "PM2-Prozess wird neu gestartet/gestartet..."
          pm2 restart housnkuh-server || pm2 start npm --name "housnkuh-server" -- start --prefix server
          
          echo "Deployment abgeschlossen."